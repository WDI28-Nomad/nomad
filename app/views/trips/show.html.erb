<!-- scripts needed for google maps -->
<script src="//maps.google.com/maps/api/js?v=3.23&key=AIzaSyATl1C376VZ4AGorIBLCyTTdc-19GynoJw&libraries=geometry&language=&hl=&region="></script>
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<script src='//cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js' type='text/javascript'></script>
<!-- scripts needed for google maps -->

<div class="col-sm-3">
  <!-- When rendering a partial from another folder, you dont need the underscore in the name of the partial -->
  <div class="row sidebar">
  <%= render "/users/sidebar" %>
  </div>
  <br>
  <div class="row">
  <%= render "/users/my_trips" %>
  </div>
</div>
<div class="col-sm-9">
  <h1 class="page-title">
    <%= click_to_edit @trip, path: user_trip_path(@user, @trip), attribute: :name %>
  </h1>
  <br>

  <!-- Budget Bar -->
  <div id="budget-bar" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
  <script>
    
  $(function () {
    var totalExpenses = 0;
    var expensesSeries = [];
    var totalBudget = parseFloat($('#trip-budget').html());

    function calculateTotal() {
      // grab all expense rows (tr)
      var expenseRows = $('.expense-row');
      // iterate over each expense
      for (var i=0; i<expenseRows.length; i++) {
        // add the expense amount to the total
        totalExpenses += parseFloat($(expenseRows[i]).data('expenseAmount'));
        // find the expense name
        var expenseName = $(expenseRows[i]).data('expenseName');
        // add the expense object to the data series
        expensesSeries.push({
          name: $(expenseRows[i]).data('expenseName'),
          data: [parseFloat($(expenseRows[i]).data('expenseAmount'))]
        });
      }

      // // Checks for totalExpenses amount and the array of expenses
      // console.info('final calculateTotal', totalExpenses);
      // console.info(expensesSeries);
    }

    calculateTotal();

    //@todo: Figure out how to draw a marker along y-values for trip budget amount.
    var chartUpdateConfig = {
      // controls the total width of the graph
      yAxis: { 
        max: totalExpenses
      },
      // data fed into the graph
      series: expensesSeries
    };

    // these attributes shouldn't change when expense/trip values update
    var chartStaticConfig = {
        chart: {
            type: 'bar'
        },
        title: {
            text: ''
        },
        xAxis: {
            categories: ['Budget Breakdown']
        },
        yAxis: {
            min: 0,
            title: {
                text: 'Total Cost'
            },
        },
        legend: {
            reversed: true
        },
        plotOptions: {
            series: {
                stacking: 'normal'
            }
        },
        credits: {
        enabled: false
        }
    };

    var finalConfig = _.extend({}, chartStaticConfig, chartUpdateConfig);
    
    function putChartOnPage (chartConfig){
      // put highcharts onto the DOM
      $('#budget-bar').highcharts(chartConfig);  
    }
    putChartOnPage(finalConfig);
    
  });

  </script>
  <!-- Budget Bar -->
  
  <h4>Budget: <%= click_to_edit @trip, path: user_trip_path(@user, @trip), attribute: :budget, id: "trip-budget" %></h4>
  <h4>Origin: <%= click_to_edit @trip, path: user_trip_path(@user, @trip), attribute: :origin %></h4>
  <h4>Destination: <%= click_to_edit @trip, path: user_trip_path(@user, @trip), attribute: :destination %></h4>

  <% if current_user %>
    <%= link_to "", edit_user_trip_path(@user, @trip), class: "glyphicon glyphicon-pencil" %>
    <%= link_to "", user_trip_path(@user, @trip), :"data-no-turbolink" => true, method: :delete, data: {confirm: "Are you sure you want to delete this trip?"}, class: "glyphicon glyphicon-trash" %>
  <% end %>
  <br>
  <hr>

  <%= link_to "Back to My Trips", user_path(@user), :"data-no-turbolink" => true, class: "btn btn-primary" %>

  <div class="add-expense-button" role="button" data-toggle="collapse" href="#collapseExample" aria-expanded="false">
    <span class = "btn btn-primary btn-lg add-expense-button">Add Expense</span>
  </div>

  <div class="collapse" id="collapseExample">
    <%= render 'expenses/form' %>
  </div>

  <div class="col-sm-8 col-sm-offset-2">
    <table id="expense-table">
      <tr class="expense-header-row">
        <td class="expense-table-header">Name</td>
        <td class="expense-table-header">Expense Type</td>
        <td class="expense-table-header">Amount</td>
        <td class="expense-table-header">Start Date</td>
        <td class="expense-table-header">End Date</td>
        <td class="expense-table-header"></td>
      </tr>
      <% @expenses.each do |e| %>
      <tr class="expense-row" 
          data-expense-type="<%= e.expense_type %>" 
          data-expense-amount="<%=e.amount%>" 
          data-expense-name="<%= e.name %>">
        <td class="expense-table"><%= e.name %></td>
        <td class="expense-table"><%= e.expense_type %></td>
        <td class="expense-table"><%= click_to_edit e, path: user_trip_expense_path(@user, @trip, e), attribute: :amount, deletable: true %></td>
        <td class="expense-table"><%= e.start_date %></td>
        <td class="expense-table"><%= e.end_date %></td>
        <td class="expense-table">
           <%= link_to "", user_trip_expense_path(@user, @trip, e),
           method: :delete,
           data: {confirm: "Are you sure you want to delete #{e.name}?"},
           class: "glyphicon glyphicon-trash pull-right" %>
           <%= link_to "", edit_user_trip_expense_path(@user, @trip, e), class: "glyphicon glyphicon-pencil pull-right" %></td>
      </tr>
      <tr>
        <% if e.expense_type == "Airfare" %>
          <td>
            <a href="http://www.kayak.com/flights" target="_blank">Find Flights</a>
          </td>
        <% elsif e.expense_type == "Lodging" %>
          <!-- Add the Origin City to the URL -->
          <td>
            <a href="https://www.kayak.com/hotels" target="_blank">Search Hotels</a>
            <a href="https://www.airbnb.com" target="_blank">Airbnb</a>
          </td>
        <% end %>
      </tr>
      <% end %>
    </table>
    <br>
  </div>
</div>
